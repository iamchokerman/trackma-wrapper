#!/bin/sh
# ik shellcheck doesnt like it and it's not posix compliant, but cba to fix it
# i also am aware there is a lot of code duplication in this script, I'll fix/clean it up later
if [[ "$OSTYPE" == "darwin"* ]]; then
	SED="gsed"
elif [[ "$OSTYPE" == "linux-gnu"* ]]; then
	SED="sed"
fi

# Quits Terminal application on exit (MacOS only)
# trap ctrl_c EXIT
# ctrl_c() {
# 	osascript -e 'quit app "Terminal"'
# }

# Exit immediately if a command exits with a non-zero status
set -e

main() {
	tput clear
	PROMPT=$(printf "watch\nbinge\nadd\ndelete\nlist\nupdate_episodes\nupdate_status\ninfo\naltname\nretrieve"|fzf)
  case $PROMPT in
    watch|binge)
      INDEX=$(printf "filter watching\nls"|trackma|$SED 's/\x1b\[[0-9;]*m//g'|$SED -n '/^|/,${p;/results/q}'|$SED '$ d'|fzf|
        awk '{print $2}')
      ANIME="$(trackma -a 1 info "$INDEX"|head -n 1)"
      EPNUM="$(trackma -a 1 search "$ANIME"|grep -Eo '[0-9]{1,3} / [0-9]{1,3}'|cut -d "/" -f 1)"
      if [[ $PROMPT == "watch" ]]; then
        python3 ~/dev/animdl/runner.py stream "$ANIME" -r $((EPNUM+1))
        # ani-cli -a $((EPNUM+1)) "$ANIME"
        # mpv $(fd "$query" /Volumes/EXTERNAL/chokerman/media/anime)
        read -r -p "Do you want to set this episode as watched? [Y/n]" response
      if [[ $response =~ ^(yes|y| ) ]] || [[ -z $response ]]; then
         trackma -a 1 update "$INDEX" $((EPNUM+1))
      fi
      else
        python3 ~/dev/animdl/runner.py stream "$ANIME" -r $((EPNUM+1))-
        # TODO: implement binge watch for ani-cli
        # ani-cli -a $((EPNUM+1)) "$ANIME"
        read -r -p "How many episodes have you watched? " EPWATCHED
        trackma -a 1 update "$INDEX" $((EPNUM+EPWATCHED))
      fi
      ;;
    add)
      read -p "What anime do you want to add? " ANIME
      ADDINDEX=$(printf "add $ANIME\n "|trackma|grep -E '[0-9]{1,2}:'|fzf|cut -d ':' -f1)
      printf "add $ANIME\n$ADDINDEX"|trackma > /dev/null
      ;;
    delete)
      INDEX="$(printf "ls"|trackma|$SED 's/\x1b\[[0-9;]*m//g'|$SED -n '/^|/,${p;/results/q}'|$SED '$ d'|fzf|awk '{print $2}')"
      printf "delete $INDEX\ny"|trackma > /dev/null
      ;;
    list)
      STATUS=$(printf "watching\ncompleted\nrewatching\npaused\ndropped\nplantowatch"|fzf)
      printf "filter $STATUS\nls"|trackma|$SED 's/\x1b\[[0-9;]*m//g'|$SED -n '/^|/,${p;/results/q}'|$SED '$ d'|less
      ;;
    update_episodes|update_status)
      STATUS=$(printf "watching\ncompleted\nrewatching\npaused\ndropped\nplantowatch"|fzf)
      INDEX="$(printf "filter $STATUS\nls"|trackma|$SED 's/\x1b\[[0-9;]*m//g'|
        $SED -n '/^|/,${p;/results/q}'|$SED '$ d'|fzf|awk '{print $2}')"
      if [[ $PROMPT == "update_episodes" ]]; then
        read -p "How many episodes have you watched? " NEWEPISODE
        printf "filter $STATUS\nupdate $INDEX $NEWEPISODE"|trackma > /dev/null
      else
        NEWSTATUS=$(printf "watching\ncompleted\nrewatching\npaused\ndropped\nplantowatch"|fzf)
        printf "filter $STATUS\nstatus $INDEX $NEWSTATUS"|trackma > /dev/null
      fi
      ;;
    info)
      STATUS=$(printf "watching\ncompleted\nrewatching\npaused\ndropped\nplantowatch"|fzf)
      INDEX="$(printf "filter $STATUS\nls"|trackma|$SED 's/\x1b\[[0-9;]*m//g'|
          $SED -n '/^|/,${p;/results/q}'|$SED '$ d'|fzf|awk '{print $2}')"
      printf "filter $STATUS\ninfo $INDEX"|trackma|sed -n '/https/,/Status/p'|sed -e 's/<[^>]*>//g'
      ;;
    altname)
      INDEX="$(printf "ls"|trackma|$SED 's/\x1b\[[0-9;]*m//g'|$SED -n '/^|/,${p;/results/q}'|$SED '$ d'|fzf|awk '{print $2}')"
      read -p "What is the new name? " NEWNAME
      printf "altname $INDEX $NEWNAME"|trackma > /dev/null
      ;;
    retrieve)
      printf "retrieve"|trackma
  esac
}

while true; do
	main
done
